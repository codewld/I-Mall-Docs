<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.36">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>身份验证及访问控制 | I-Mall-Docs</title><meta name="description" content="一个简单的商城，持续开发中！">
    <link rel="modulepreload" href="/I-Mall-Docs/assets/app.a704330d.js"><link rel="modulepreload" href="/I-Mall-Docs/assets/身份验证及访问控制.html.3308ad52.js"><link rel="modulepreload" href="/I-Mall-Docs/assets/身份验证及访问控制.html.3fc8b73d.js"><link rel="modulepreload" href="/I-Mall-Docs/assets/plugin-vue_export-helper.21dcd24c.js">
    <link rel="stylesheet" href="/I-Mall-Docs/assets/style.c36ee4e4.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/I-Mall-Docs/" class=""><!----><span class="site-name">I-Mall-Docs</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a class="external-link" href="https://github.com/codewld/I-Mall" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a class="external-link" href="https://github.com/codewld/I-Mall" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/I-Mall-Docs/" class="sidebar-item sidebar-heading" aria-label="介绍"><!--[--><!--]--> 介绍 <!--[--><!--]--></a><!----></li><li><a href="/I-Mall-Docs/technology-stack/" class="sidebar-item sidebar-heading" aria-label="技术栈"><!--[--><!--]--> 技术栈 <!--[--><!--]--></a><!----></li><li><a href="/I-Mall-Docs/change-log/" class="sidebar-item sidebar-heading" aria-label="更新日志"><!--[--><!--]--> 更新日志 <!--[--><!--]--></a><!----></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">技术要点 <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/I-Mall-Docs/technology-point/身份验证及访问控制.md" class="sidebar-item active" aria-label="身份验证及访问控制"><!--[--><!--]--> 身份验证及访问控制 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="身份验证及访问控制" tabindex="-1"><a class="header-anchor" href="#身份验证及访问控制" aria-hidden="true">#</a> 身份验证及访问控制</h1><h2 id="一、技术栈" tabindex="-1"><a class="header-anchor" href="#一、技术栈" aria-hidden="true">#</a> 一、技术栈</h2><ul><li>Spring Security</li><li>JWT</li><li>Redis</li></ul><h2 id="二、基本概念" tabindex="-1"><a class="header-anchor" href="#二、基本概念" aria-hidden="true">#</a> 二、基本概念</h2><ul><li>用户，对应使用者，每个用户可以拥有多个角色</li><li>角色，每个角色可以拥有多个权限</li><li>权限，当前版本为页面级权限，一个权限对应前端的一个页面和后端的一个 Controller</li></ul><h2 id="三、spring-security" tabindex="-1"><a class="header-anchor" href="#三、spring-security" aria-hidden="true">#</a> 三、Spring Security</h2><p>待更新</p><h2 id="四、jwt" tabindex="-1"><a class="header-anchor" href="#四、jwt" aria-hidden="true">#</a> 四、JWT</h2><h3 id="_1-作用" tabindex="-1"><a class="header-anchor" href="#_1-作用" aria-hidden="true">#</a> 1. 作用</h3><p>JWT 有着自鉴权的特点，因此可以在不耗费服务器内存空间（存储 Session）的情况下实现认证。</p><h3 id="_2-存储内容" tabindex="-1"><a class="header-anchor" href="#_2-存储内容" aria-hidden="true">#</a> 2. 存储内容</h3><p>JWT 中存储 <code>ID、username、角色ID列表、签发时间、过期时间</code> 。</p><h3 id="_3-为什么不存储权限" tabindex="-1"><a class="header-anchor" href="#_3-为什么不存储权限" aria-hidden="true">#</a> 3. 为什么不存储权限？</h3><ul><li>如果存储，JWT 体积势必会增大，请求中携带它将极大地耗费网络资源</li><li>如果存储，当角色所属的权限发生变更时将难以处理</li><li>每个角色拥有的权限在同一时间是相同的，可以方便地缓存、&quot;轻松&quot; 地获取</li></ul><h2 id="五、redis" tabindex="-1"><a class="header-anchor" href="#五、redis" aria-hidden="true">#</a> 五、Redis</h2><h3 id="_1-缓存被禁用用户" tabindex="-1"><a class="header-anchor" href="#_1-缓存被禁用用户" aria-hidden="true">#</a> 1. 缓存被禁用用户</h3><h4 id="_1-背景" tabindex="-1"><a class="header-anchor" href="#_1-背景" aria-hidden="true">#</a> (1) 背景</h4><p>如果用户被禁用，该用户数据库中的 status 字段将会被设为 true，他将不再能进行任何操作。</p><p>用户的禁用需要两部分工作：</p><ul><li>不得登录：由于登录时本来就要查询数据库，因此只需要简单判断一下用户实体的 status 属性即可</li><li>不得发送请求：由于 JWT 是自鉴权的，为了能够禁用用户，我们必须额外进行查询数据库的操作，为了减轻数据库负担、提升查询效率，可以利用 Redis 缓存数据库中所有被禁用用户</li></ul><h4 id="_2-思路" tabindex="-1"><a class="header-anchor" href="#_2-思路" aria-hidden="true">#</a> (2) 思路</h4><p>将当前所有的 &quot;被禁用用户&quot; 缓存，当 <code>JWTVerifyFilter</code> 接收到请求时，查询缓存，判断当前用户是否被禁用。</p><h4 id="_3-具体实现" tabindex="-1"><a class="header-anchor" href="#_3-具体实现" aria-hidden="true">#</a> (3) 具体实现</h4><ul><li>在 <code>UmsAdminService</code> 中增加 <code>listDisabled()</code> 方法，它将会向数据库中查询所有被禁用的用户</li><li>为 <code>listDisabled()</code> 方法增加 <code>@Cacheable(value = &quot;DisabledAdmin&quot;)</code>，使 SpringBoot 自动缓存其结果</li><li>为 <strong>增、删</strong> 方法添加 <code>@CacheEvict</code> 注解，当改动涉及 status 字段时清空缓存</li><li>在登录状态读取器 <code>JWTVerifyFilter</code> 中调用 <code>listDisabled()</code> 方法获取所有被禁用用户，判断当前用户是否被禁用</li></ul><h3 id="_2-使已签发的-jwt-失效" tabindex="-1"><a class="header-anchor" href="#_2-使已签发的-jwt-失效" aria-hidden="true">#</a> 2. 使已签发的 JWT 失效</h3><h4 id="_1-背景-1" tabindex="-1"><a class="header-anchor" href="#_1-背景-1" aria-hidden="true">#</a> (1) 背景</h4><p>JWT 拥有自校验的特性，这使得它可以自行保存信息，从而替代 Session。</p><p>但 JWT 的自校验机制也带来了一个问题，JWT 一旦签发，在其有效期内它将始终有效，这导致用户的认证是不可控的，我们无法实现诸如强制下线某用户的操作。</p><h4 id="_2-思路-1" tabindex="-1"><a class="header-anchor" href="#_2-思路-1" aria-hidden="true">#</a> (2) 思路</h4><p>通过 &quot;外挂校验&quot; 的方式解决。</p><p>缓存用户 ID 及最早有效时间（设为当前时间），接收到 JWT 时，判断其是否有对应的缓存，如果有，判断其是否早于最早有效时间颁发，如果是，则要求重新登录。</p><p>如此，我们便实现了将已签发的 JWT 强制失效，要求用户重新登录的愿望。</p><h4 id="_3-具体实现-1" tabindex="-1"><a class="header-anchor" href="#_3-具体实现-1" aria-hidden="true">#</a> (3) 具体实现</h4><ul><li>在 <code>UmsAdminService</code> 中增加 <code>invalidateIssuedJWT(Long id)</code> 方法，它接收用户 ID，并将用户 ID 及当前时间存储进缓存之中</li><li>在 <code>UmsAdminService</code> 中增加 <code>isJWTInvalidated(Long id, Long time)</code> 方法，它接收用户 ID 及 JWT 的签发时间，返回 JWT 是否失效</li><li>在我们希望 JWT 失效的典型场景，例如删除用户、修改密码，调用 <code>invalidateIssuedJWT(Long id)</code> 方法使已签发的 JWT 失效</li><li>在登录状态读取器 <code>JWTVerifyFilter</code> 中，首先解析获得用户 ID 及签发时间，然后调用 <code>isJWTInvalidated(Long id, Long time)</code> 判断 JWT 是否失效</li></ul><h3 id="_3-缓存角色对应的权限" tabindex="-1"><a class="header-anchor" href="#_3-缓存角色对应的权限" aria-hidden="true">#</a> 3. 缓存角色对应的权限</h3><h4 id="_1-背景-2" tabindex="-1"><a class="header-anchor" href="#_1-背景-2" aria-hidden="true">#</a> (1) 背景</h4><p><code>JWTVerifyFilter</code> 负责解析请求中的 JWT、读取登录状态。</p><p>当 <code>JWTVerifyFilter</code> 接收到请求时，需要根据 JWT 中存储的角色信息获取当前用户所拥有的权限，并将权限信息提供给 Spring Security 框架。</p><h4 id="_2-思路-2" tabindex="-1"><a class="header-anchor" href="#_2-思路-2" aria-hidden="true">#</a> (2) 思路</h4><p>将每个角色（通过 ID 标识）对应的权限信息缓存，当接收到请求时，遍历角色信息，获取每个角色对应的权限，对所有的权限信息进行整合、去重处理，放入 Spring Security 安全上下文之中。</p><h3 id="_4-缓存菜单" tabindex="-1"><a class="header-anchor" href="#_4-缓存菜单" aria-hidden="true">#</a> 4. 缓存菜单</h3><h4 id="_1-背景-3" tabindex="-1"><a class="header-anchor" href="#_1-背景-3" aria-hidden="true">#</a> (1) 背景</h4><p>在本系统中，用户登录后需要请求 <code>/account/router</code> 接口以获取当前用户的路由信息，从而构建前端系统。</p><p>该接口的访问是较为高频的，且一次访问可能会多次查询数据库，因此缓存是十分有必要的。</p><h4 id="_2-思路-3" tabindex="-1"><a class="header-anchor" href="#_2-思路-3" aria-hidden="true">#</a> (2) 思路</h4><p>首先，后端会根据 Spring Security 安全上下文中的权限信息获取用户所能访问的页面，因此应该缓存由编码查询的菜单；</p><p>其次，为了组合为树形，会递归地根据 parentId 查询父级菜单，因此应该缓存由 ID 查询的菜单。</p><h2 id="六、几个小问题" tabindex="-1"><a class="header-anchor" href="#六、几个小问题" aria-hidden="true">#</a> 六、几个小问题</h2><h3 id="_1-角色对应的权限发生更新怎么办" tabindex="-1"><a class="header-anchor" href="#_1-角色对应的权限发生更新怎么办" aria-hidden="true">#</a> 1. 角色对应的权限发生更新怎么办？</h3><p>JWT 中并不携带权限信息，而是通过角色信息向缓存获取，我们只需要适时清空缓存重新获取，便可以保证角色对应的权限信息真实有效。</p><h3 id="_2-用户路由发生更新怎么办" tabindex="-1"><a class="header-anchor" href="#_2-用户路由发生更新怎么办" aria-hidden="true">#</a> 2. 用户路由发生更新怎么办？</h3><p>首先理清一个概念，本系统中路由同时指代系统导航栏及 Vue Router 中的路由，它们均由相同的路由信息生成。</p><p>本系统采取了动态路由的方式，用户登录成功后应首先向 &quot;路由接口&quot; 发送请求，后端将会通过 <code>用户 - 角色 - 权限 - 路由</code> 的方式生成路由信息并返回。</p><p>后端可以保证的是每次请求 &quot;路由接口&quot; 时都可以获取到最新的路由信息，但结合前端便会出现一些问题：</p><ul><li>如果不对路由信息进行持久化，可以尽可能地保证路由信息的及时性，但每次刷新页面都需要重新获取路由，这将极大地耗费网络资源</li><li>如果对路由信息进行持久化，路由信息将会被存储在浏览器会话存储空间中，刷新页面无需重新获取，但可能会导致路由信息不及时</li></ul><p>综合考虑下，本系统选用了对路由信息持久化的方法，原因如下：</p><ul><li>角色对应权限的改动不是很频繁，没有必要为此平白耗费网络资源</li><li>如果用户的权限进行扩充，路由未发生及时更新，推荐的解决方案是让用户重新登录</li><li>如果用户的权限进行缩窄，路由未发生及时更新，如果用户进入了已经不属于它的页面，后端会返回 &quot;权限验证错误状态码&quot;，前端重新进行路由信息的获取</li></ul><h3 id="_3-用户对应的角色发生更新怎么办" tabindex="-1"><a class="header-anchor" href="#_3-用户对应的角色发生更新怎么办" aria-hidden="true">#</a> 3. 用户对应的角色发生更新怎么办？</h3><p>使用户对应的已签发的 JWT 失效，要求重新登陆。</p><h3 id="_4-用户发生更新怎么办" tabindex="-1"><a class="header-anchor" href="#_4-用户发生更新怎么办" aria-hidden="true">#</a> 4. 用户发生更新怎么办？</h3><p>用户信息的修改分为以下几种情况：</p><h4 id="_1-基本信息修改" tabindex="-1"><a class="header-anchor" href="#_1-基本信息修改" aria-hidden="true">#</a> (1) 基本信息修改</h4><p>在本系统中，JWT 作为认证凭据而非信息来源，因此用户信息的更改（包括用户名）无需反映到 JWT 之上。</p><h4 id="_2-密码修改" tabindex="-1"><a class="header-anchor" href="#_2-密码修改" aria-hidden="true">#</a> (2) 密码修改</h4><p>如果修改了 password 字段，便是进行了密码修改，此时应使用户对应的已签发的 JWT 失效，要求重新登陆。</p><h4 id="_3-用户禁用" tabindex="-1"><a class="header-anchor" href="#_3-用户禁用" aria-hidden="true">#</a> (3) 用户禁用</h4><p>如果修改了 status 字段，将用户禁用，此时应该更新缓存中的禁用用户名单。</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/I-Mall-Docs/assets/app.a704330d.js" defer></script>
  </body>
</html>
